#Build the environment
FROM node:10 as builder
EXPOSE 3000

RUN apt-get update && apt-get upgrade -y && apt-get install -y jq git

COPY ./maproulette3 /maproulette-frontend

WORKDIR /maproulette-frontend
RUN chmod 755 /maproulette-frontend
ADD .env.development.local /maproulette-frontend/.env

# Build the Maproulette Frontend
RUN yarn && yarn run build

# Production environment
FROM nginx:1.15.8-alpine
RUN mkdir -p /var/www/maproulette
COPY --from=builder /maproulette-frontend/build /var/www/maproulette
RUN mkdir -p /etc/nginx/sites-enabled
ADD nginx-config /etc/nginx/sites-enabled/maproulette
ADD nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
